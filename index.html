<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üìö Kiddo Book Stall</title>
<style>
  :root{
    --bg:#0b1020; --card:#0f1726; --muted:#9fb0c4;
    --accent1:#00e6a8; --accent2:#00a8ff; --warm:#ffb020;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: "Poppins", Inter, system-ui, sans-serif;
    background: linear-gradient(180deg,var(--bg),#06101a);
    color:#eaf4ff; min-height:100vh; display:flex; flex-direction:column;
  }

  /* Header */
  header{
    padding:18px 14px; text-align:center;
    background: linear-gradient(90deg,var(--accent1),var(--accent2));
    color:#001; font-weight:800; font-size:18px;
    border-bottom-left-radius:18px; border-bottom-right-radius:18px;
    box-shadow:0 8px 30px rgba(0,0,0,0.45);
    position:relative;
    user-select:none;
  }
  header small{ display:block; font-weight:700; color:#032; margin-top:6px; font-size:12px; opacity:0.95;}

  main{ flex:1; width:100%; max-width:980px; margin:16px auto; padding:12px; box-sizing:border-box; }

  .intro{
    text-align:center; margin-bottom:14px; color:var(--muted);
    font-size:14px;
  }

  .grid{
    display:grid; gap:12px;
    grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
  }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:8px;
    min-height:170px; align-items:center; box-shadow:0 10px 30px rgba(0,0,0,0.6);
    transition: transform .18s ease, box-shadow .18s ease;
    border: 1px solid rgba(255,255,255,0.03);
  }
  .card:hover{ transform: translateY(-6px); box-shadow:0 20px 50px rgba(0,0,0,0.7); }
  .emoji{ font-size:44px }
  .title{ color:var(--accent1); font-weight:800; font-size:15px; text-align:center; }
  .desc{ color:var(--muted); font-size:13px; text-align:center; flex:1; display:flex; align-items:center; justify-content:center; padding:0 6px; }

  .row{ display:flex; gap:8px; align-items:center; justify-content:center; width:100%; margin-top:6px; }
  .btn{
    background: linear-gradient(90deg,var(--accent1),var(--accent2));
    color:#001; padding:9px 12px; border-radius:999px; font-weight:800; border:none; cursor:pointer;
    display:inline-flex; gap:8px; align-items:center; text-decoration:none;
  }
  .btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); padding:8px 10px; font-weight:700; }

  .status{ text-align:center; color:var(--muted); margin-top:12px; font-size:13px; }

  footer{ text-align:center; padding:12px 10px; color:var(--muted); font-size:13px; margin-top:12px }

  /* Admin panel (slide-in) */
  #adminPanel{
    position:fixed; right:14px; top:88px; width:94%; max-width:420px; z-index:120;
    background: linear-gradient(180deg,#071422,#091827); border-radius:12px; padding:12px;
    box-shadow:0 18px 50px rgba(0,0,0,0.7); color:#dfeeff; display:none;
  }
  #adminPanel h4{ margin:0 0 8px; font-size:16px }
  .admin-row{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px dashed rgba(255,255,255,0.03) }
  .admin-list{ max-height:56vh; overflow:auto; margin-top:8px; padding-right:6px }

  .small-btn{ padding:8px 10px; border-radius:8px; font-weight:700; background:transparent; color:#dfeeff; border:1px solid rgba(255,255,255,0.04); cursor:pointer; }

  /* Modal */
  .modal-backdrop{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:220; }
  .modal{ background:linear-gradient(180deg,#0b1620,#07101a); padding:16px; border-radius:12px; width:92%; max-width:520px; color:#eaf4ff; box-shadow:0 12px 40px rgba(0,0,0,0.6); }
  .row-input{ display:flex; gap:8px; margin-top:10px; }
  input[type="text"], input[type="password"], textarea{
    flex:1; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:#eaf4ff;
  }
  .muted{ color:var(--muted); font-size:13px; margin-top:8px; }

  @media (max-width:420px){
    .emoji{ font-size:40px }
  }
</style>
</head>
<body>

<header id="siteHeader" title="Long-press here to open admin login">
  üìö Kiddo Book Stall
  <small>‡¶ú‡ßÅ‡¶¨‡¶æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶∏‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶è‡¶∞ ‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶∏‡ßÅ‡¶≤ (‡ßß‚Äì‡ß´) ‚Äî long-press header to login</small>
</header>

<main>
  <div class="intro">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßÄ‡ßü ‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶∏‡ßÅ‡¶≤ ‡¶¨‡ßá‡¶õ‡ßá Download ‡¶ï‡¶∞‡ßÅ‡¶® ‚Äî ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶æ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡¶æ‡ßú‡¶¨‡ßá (Admin ‡¶è ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá)</div>

  <div class="grid" id="grid"></div>

  <div class="status" id="status">‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§ ‚Äî ‡ß´‡¶ü‡¶ø ‡¶´‡¶æ‡¶á‡¶≤</div>
</main>

<!-- Admin slide panel -->
<div id="adminPanel" aria-hidden="true">
  <h4>üîê Admin Dashboard</h4>
  <div class="admin-row"><div>‡¶Æ‡ßã‡¶ü Downloads</div><div id="totalDownloads">0</div></div>
  <div class="admin-row"><div>‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ</div><div id="totalBooks">0</div></div>

  <div style="margin-top:8px; font-weight:800">üìö Books</div>
  <div class="admin-list" id="adminBookList"></div>

  <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
    <button id="openAdd" class="small-btn">‚ûï Add New</button>
    <button id="closeAdmin" class="small-btn" style="margin-left:auto">üîí Hide</button>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" id="modalContent"></div>
</div>

<footer>¬© ‡ß®‡ß¶‡ß®‡ß´ ‚Ä¢ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶® ‚ù§Ô∏è Kamrul</footer>

<script>
/*
  Kiddo Book Stall ‚Äî final version
  - Long-press header (1.2s) to open admin login modal (password input masked)
  - Default admin password (in code) is used to initialize storage but NOT shown anywhere.
  - Admin can add/edit/delete books and change admin password.
  - Downloads open raw links in new tab to avoid CORS; each download increments counts + total.
  - No "Download All" button as requested.
*/

/* ---------- Configuration ---------- */
const DEFAULT_ADMIN_PASS = 'kiddo2025'; // initial password (not shown). Change here if you want.
const KEY_BOOKS = 'kiddo_kiddo_books_v2';
const KEY_STATS = 'kiddo_kiddo_stats_v2';
const KEY_ADMIN = 'kiddo_kiddo_admin_v2';

/* ---------- Helper functions ---------- */
function genId(){ return 'b_'+Math.random().toString(36).slice(2,9); }
function save(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function load(key){ const s = localStorage.getItem(key); return s ? JSON.parse(s) : null; }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ---------- Default books (using your supplied links as-is) ---------- */
const DEFAULT_BOOKS = [
  { id: genId(), emoji:'üìó', title:'‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶∏‡ßÅ‡¶≤ ‡ßß', desc:'‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶æ‡¶¨‡¶≤‡¶ø', url:'https://raw.githubusercontent.com/kamrul-nova-06/Kiddo-kamrul/main/%E0%A6%B8%E0%A6%BE%E0%A6%AE%E0%A7%8D%E0%A6%AA%E0%A7%8D%E0%A6%B0%E0%A6%A4%E0%A6%BF%E0%A6%95%20%E0%A6%95%E0%A7%8D%E0%A6%AF%E0%A6%BE%E0%A6%AA%E0%A6%B8%E0%A7%81%E0%A6%B2-%E0%A7%A7.pdf', downloads:0 },
  { id: genId(), emoji:'üìò', title:'‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶∏‡ßÅ‡¶≤ ‡ß®', desc:'‡¶ö‡¶≤‡¶Æ‡¶æ‡¶® ‡¶ò‡¶ü‡¶®‡¶æ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£', url:'https://raw.githubusercontent.com/kamrul-nova-06/Kiddo-kamrul/main/%E0%A6%B8%E0%A6%BE%E0%A6%AE%E0%A7%8D%E0%A6%AA%E0%A7%8D%E0%A6%B0%E0%A6%A4%E0%A6%BF%E0%A6%95%20%E0%A6%95%E0%A7%8D%E0%A6%AF%E0%A6%BE%E0%A6%AA%E0%A6%B8%E0%A7%81%E0%A6%B2-%E0%A7%A8.pdf%95%20%E0%A6%95%E0%A7%8D%E0%A6%AF%E0%A6%BE%E0%A6%AA%E0%A6%B8%E0%A7%81%E0%A6%B2-%E0%A7%A7.pdf', downloads:0 },
  { id: genId(), emoji:'üìô', title:'‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶∏‡ßÅ‡¶≤ ‡ß©', desc:'‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶®‡ßã‡¶ü ‡¶ì ‡¶§‡¶•‡ßç‡¶Ø', url:'https://raw.githubusercontent.com/kamrul-nova-06/Kiddo-kamrul/main/%E0%A6%B8%E0%A6%BE%E0%A6%AE%E0%A7%8D%E0%A6%AA%E0%A7%8D%E0%A6%B0%E0%A6%A4%E0%A6%BF%E0%A6%95%20%E0%A6%95%E0%A7%8D%E0%A6%AF%E0%A6%BE%E0%A6%AA%E0%A6%B8%E0%A7%81%E0%A6%B2-%E0%A7%A9.pdf%95%20%E0%A6%95%E0%A7%8D%E0%A6%AF%E0%A6%BE%E0%A6%AA%E0%A6%B8%E0%A7%81%E0%A6%B2-%E0%A7%A8.pdf%95%20%E0%A6%95%E0%A7%8D%E0%A6%AF%E0%A6%BE%E0%A6%AA%E0%A6%B8%E0%A7%81%E0%A6%B2-%E0%A7%A7.pdf', downloads:0 },
  { id: genId(), emoji:'üìï', title:'‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶∏‡ßÅ‡¶≤ ‡ß™', desc:'‡¶ö‡¶≤‡¶§‡¶ø ‡¶ò‡¶ü‡¶®‡¶æ‡¶¨‡¶≤‡¶ø‡¶∞ ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™', url:'https://raw.githubusercontent.com/kamrul-nova-06/Kiddo-kamrul/main/%E0%A6%B8%E0%A6%BE%E0%A6%AE%E0%A7%8D%E0%A6%AA%E0%A7%8D%E0%A6%B0%E0%A6%A4%E0%A6%BF%E0%A6%95%20%E0%A6%95%E0%A7%8D%E0%A6%AF%E0%A6%BE%E0%A6%AA%E0%A6%B8%E0%A7%81%E0%A6%B2-%E0%A7%AA.pdf5%20%E0%A6%95%E0%A7%8D%E0%A6%AF%E0%A6%BE%E0%A6%AA%E0%A6%B8%E0%A7%81%E0%A6%B2-%E0%A7%A9.pdf%95%20%E0%A6%95%E0%A7%8D%E0%A6%AF%E0%A6%BE%E0%A6%AA%E0%A6%B8%E0%A7%81%E0%A6%B2-%E0%A7%A8.pdf%95%20%E0%A6%95%E0%A7%8D%E0%A6%AF%E0%A6%BE%E0%A6%AA%E0%A6%B8%E0%A7%81%E0%A6%B2-%E0%A7%A7.pdf', downloads:0 },
  { id: genId(), emoji:'üìí', title:'‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶∏‡ßÅ‡¶≤ ‡ß´', desc:'‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ó‡¶æ‡¶ú‡¶ø‡¶® ‡¶ü‡¶æ‡¶á‡¶™ ‡¶§‡¶•‡ßç‡¶Ø', url:'https://raw.githubusercontent.com/kamrul-nova-06/Kiddo-kamrul/main/%E0%A6%B8%E0%A6%BE%E0%A6%AE%E0%A7%8D%E0%A6%AA%E0%A7%8D%E0%A6%B0%E0%A6%A4%E0%A6%BF%E0%A6%95%20%E0%A6%95%E0%A7%8D%E0%A6%AF%E0%A6%BE%E0%A6%AA%E0%A6%B8%E0%A7%81%E0%A6%B2-%E0%A7%AB.pdf%95%20%E0%A6%95%E0%A7%8D%E0%A6%AF%E0%A6%BE%E0%A6%AA%E0%A6%B8%E0%A7%81%E0%A6%B2-%E0%A7%AA.pdf5%20%E0%A6%95%E0%A7%8D%E0%A6%AF%E0%A6%BE%E0%A6%AA%E0%A6%B8%E0%A7%81%E0%A6%B2-%E0%A7%A9.pdf%95%20%E0%A6%95%E0%A7%8D%E0%A6%AF%E0%A6%BE%E0%A6%AA%E0%A6%B8%E0%A7%81%E0%A6%B2-%E0%A7%A8.pdf%95%20%E0%A6%95%E0%A7%8D%E0%A6%AF%E0%A6%BE%E0%A6%AA%E0%A6%B8%E0%A7%81%E0%A6%B2-%E0%A7%A7.pdf', downloads:0 }
];

/* ---------- Storage init ---------- */
let books = load(KEY_BOOKS) || DEFAULT_BOOKS.slice();
let stats = load(KEY_STATS) || { totalDownloads: 0 };
let admin = load(KEY_ADMIN) || { passHash: null }; // passHash will be set below if null

// initialize admin passHash in storage (hashed) if not present
(function ensureAdminPass(){
  if(!admin.passHash){
    // simple hash (SHA-256) of DEFAULT_ADMIN_PASS stored to avoid plain-text in storage
    hashString(DEFAULT_ADMIN_PASS).then(h=>{
      admin.passHash = h;
      save(KEY_ADMIN, admin);
    });
  }
})();

/* ---------- DOM refs ---------- */
const grid = document.getElementById('grid');
const statusEl = document.getElementById('status');
const totalDownloadsEl = document.getElementById('totalDownloads');
const totalBooksEl = document.getElementById('totalBooks');
const adminPanel = document.getElementById('adminPanel');
const adminBookList = document.getElementById('adminBookList');
const modalBackdrop = document.getElementById('modalBackdrop');
const modalContent = document.getElementById('modalContent');

/* ---------- Render functions ---------- */
function renderBooks(){
  grid.innerHTML = '';
  books.forEach(b=>{
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="emoji">${escapeHtml(b.emoji || 'üìï')}</div>
      <div class="title">${escapeHtml(b.title)}</div>
      <div class="desc">${escapeHtml(b.desc)}</div>
      <div class="row">
        <button class="btn" data-id="${b.id}" data-action="download">‚¨áÔ∏è ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
      </div>
    `;
    grid.appendChild(card);
  });
  statusEl.textContent = `‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§ ‚Äî ${books.length} ‡¶´‡¶æ‡¶á‡¶≤`;
  totalBooksEl.textContent = books.length;
  totalDownloadsEl.textContent = stats.totalDownloads || 0;
  renderAdminList();
}

function renderAdminList(){
  adminBookList.innerHTML = '';
  books.forEach(b=>{
    const row = document.createElement('div'); row.className='admin-row';
    row.innerHTML = `
      <div style="flex:1;min-width:0">
        <div style="font-weight:800">${escapeHtml(b.title)} <span style="color:var(--muted);font-weight:600;font-size:12px">(${b.downloads||0})</span></div>
        <div style="font-size:12px;color:var(--muted);margin-top:6px">${escapeHtml(b.desc)}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:6px;word-break:break-all">${escapeHtml(b.url)}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;margin-left:8px">
        <button class="small-btn" data-action="edit" data-id="${b.id}">‚úèÔ∏è Edit</button>
        <button class="small-btn" data-action="delete" data-id="${b.id}">üóëÔ∏è Delete</button>
      </div>
    `;
    adminBookList.appendChild(row);
  });
}

/* ---------- Download behavior (open in new tab & record) ---------- */
function openInNewTab(url){
  const a = document.createElement('a');
  a.href = url;
  a.target = '_blank';
  a.rel = 'noopener noreferrer';
  document.body.appendChild(a);
  a.click();
  a.remove();
}

function recordDownload(bookId){
  const b = books.find(x=>x.id===bookId);
  if(!b) return;
  b.downloads = (b.downloads || 0) + 1;
  stats.totalDownloads = (stats.totalDownloads || 0) + 1;
  save(KEY_BOOKS, books);
  save(KEY_STATS, stats);
  renderBooks();
}

/* event delegation for download buttons */
grid.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-action="download"]');
  if(!btn) return;
  const id = btn.dataset.id;
  const b = books.find(x=>x.id===id);
  if(!b){ alert('File not found'); return; }
  openInNewTab(b.url);
  recordDownload(id);
  showToast(`${b.title} ‡¶ñ‡ßÅ‡¶≤‡ßá ‡¶¶‡ßá‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°/‡¶ì‡¶™‡ßá‡¶®)`);
});

/* ---------- Admin long-press login (header) ---------- */
const header = document.getElementById('siteHeader');
let pressTimer = null;
function startPress(){
  clearTimeout(pressTimer);
  pressTimer = setTimeout(()=> {
    showLoginModal();
  }, 1200);
}
function cancelPress(){ clearTimeout(pressTimer); }

header.addEventListener('touchstart', startPress);
header.addEventListener('mousedown', startPress);
header.addEventListener('touchend', cancelPress);
header.addEventListener('mouseup', cancelPress);
header.addEventListener('mouseleave', cancelPress);

/* ---------- Modal helpers ---------- */
function showModal(html){
  modalContent.innerHTML = html;
  modalBackdrop.style.display = 'flex';
}
function hideModal(){ modalBackdrop.style.display = 'none'; modalContent.innerHTML=''; }

/* ---------- Login modal ---------- */
function showLoginModal(){
  const html = `
    <h3>üîê Admin Login</h3>
    <div class="muted">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ö‡¶™‡¶∂‡¶®: Admin password change ‡¶π‡¶¨‡ßá Dashboard ‡¶•‡ßá‡¶ï‡ßá)</div>
    <div class="row-input" style="margin-top:12px">
      <input id="adminPass" type="password" placeholder="Admin password">
      <button id="loginBtn" class="small-btn">Login</button>
    </div>
    <div class="muted" style="margin-top:8px">(‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ø‡¶¶‡¶ø ‡¶™‡¶æ‡¶∏ ‡¶≠‡ßÅ‡¶≤ ‡¶Æ‡¶®‡ßá ‡¶ï‡¶∞‡ßá‡¶®, Dashboard ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶ö‡ßá‡¶û‡ßç‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶®)</div>
  `;
  showModal(html);
  document.getElementById('loginBtn').addEventListener('click', async ()=>{
    const val = document.getElementById('adminPass').value || '';
    const stored = load(KEY_ADMIN) || {};
    const storedHash = stored.passHash || await hashString(DEFAULT_ADMIN_PASS);
    const valHash = await hashString(val);
    if(valHash === storedHash){
      hideModal();
      openAdminPanel();
      showToast('Admin authenticated ‚Äî Dashboard ‡¶ñ‡ßÅ‡¶≤‡ßá ‡¶¶‡ßá‡ßü‡¶æ ‡¶π‡¶≤‡ßã');
    } else {
      alert('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤');
    }
  });
}

/* ---------- Admin panel open/close ---------- */
function openAdminPanel(){
  adminPanel.style.display = 'block';
  adminPanel.setAttribute('aria-hidden','false');
}
document.getElementById('closeAdmin').addEventListener('click', ()=> {
  adminPanel.style.display = 'none';
  adminPanel.setAttribute('aria-hidden','true');
});

/* ---------- Admin list actions (edit/delete) ---------- */
adminBookList.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('button');
  if(!btn) return;
  const id = btn.dataset.id;
  const action = btn.dataset.action;
  if(action === 'delete'){
    if(confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')){
      books = books.filter(x=>x.id !== id);
      save(KEY_BOOKS, books);
      renderBooks();
      showToast('‡¶¨‡¶á ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
    }
  } else if(action === 'edit'){
    const book = books.find(x=>x.id===id);
    if(book) showEditModal(book);
  }
});

/* ---------- Add new book ---------- */
document.getElementById('openAdd').addEventListener('click', ()=> showAddModal());

function showAddModal(){
  const html = `
    <h3>‚ûï Add New Book</h3>
    <div class="row-input" style="margin-top:10px">
      <input id="newTitle" placeholder="Title (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)">
    </div>
    <div class="row-input" style="margin-top:8px">
      <input id="newEmoji" placeholder="Emoji (e.g., üìó)">
      <input id="newDesc" placeholder="Short description">
    </div>
    <div class="row-input" style="margin-top:8px">
      <input id="newURL" placeholder="Raw file URL (https://raw.githubusercontent.com/...)">
    </div>
    <div style="margin-top:10px; display:flex; gap:8px">
      <button id="saveNew" class="small-btn">Save</button>
      <button id="cancelNew" class="small-btn">Cancel</button>
    </div>
  `;
  showModal(html);
  document.getElementById('cancelNew').addEventListener('click', hideModal);
  document.getElementById('saveNew').addEventListener('click', ()=>{
    const title = document.getElementById('newTitle').value.trim();
    const emoji = document.getElementById('newEmoji').value.trim() || 'üìï';
    const desc = document.getElementById('newDesc').value.trim() || '';
    const url = document.getElementById('newURL').value.trim();
    if(!title || !url){ alert('Title ‡¶è‡¶¨‡¶Ç URL ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá'); return; }
    const nb = { id: genId(), emoji, title, desc, url, downloads:0 };
    books.unshift(nb);
    save(KEY_BOOKS, books);
    renderBooks();
    hideModal();
    showToast('‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶á ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
  });
}

/* ---------- Edit modal ---------- */
function showEditModal(book){
  const html = `
    <h3>‚úèÔ∏è Edit Book</h3>
    <div class="row-input" style="margin-top:10px">
      <input id="eTitle" value="${escapeHtml(book.title)}">
    </div>
    <div class="row-input" style="margin-top:8px">
      <input id="eEmoji" value="${escapeHtml(book.emoji||'')}">
      <input id="eDesc" value="${escapeHtml(book.desc||'')}">
    </div>
    <div class="row-input" style="margin-top:8px">
      <input id="eURL" value="${escapeHtml(book.url||'')}">
    </div>
    <div style="margin-top:10px; display:flex; gap:8px">
      <button id="saveEdit" class="small-btn">Save</button>
      <button id="cancelEdit" class="small-btn">Cancel</button>
      <button id="changePass" class="small-btn" style="margin-left:auto">üîë Change Pass</button>
    </div>
  `;
  showModal(html);
  document.getElementById('cancelEdit').addEventListener('click', hideModal);
  document.getElementById('saveEdit').addEventListener('click', ()=>{
    const title = document.getElementById('eTitle').value.trim();
    const emoji = document.getElementById('eEmoji').value.trim() || 'üìï';
    const desc = document.getElementById('eDesc').value.trim() || '';
    const url = document.getElementById('eURL').value.trim();
    if(!title || !url){ alert('Title ‡¶è‡¶¨‡¶Ç URL ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá'); return; }
    const idx = books.findIndex(x=>x.id===book.id);
    if(idx>=0){
      books[idx].title = title; books[idx].emoji = emoji; books[idx].desc = desc; books[idx].url = url;
      save(KEY_BOOKS, books);
      renderBooks();
      hideModal();
      showToast('‡¶¨‡¶á ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
    }
  });
  document.getElementById('changePass').addEventListener('click', ()=> {
    hideModal();
    showChangePassModal();
  });
}

/* ---------- Change admin password modal ---------- */
function showChangePassModal(){
  const html = `
    <h3>üîë Change Admin Password</h3>
    <div class="muted">‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Ü‡¶∞ ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá ‡¶®‡¶æ)</div>
    <div class="row-input" style="margin-top:10px">
      <input id="newPass" type="password" placeholder="New password">
      <input id="confirmPass" type="password" placeholder="Confirm">
    </div>
    <div style="margin-top:10px; display:flex; gap:8px">
      <button id="savePass" class="small-btn">Save</button>
      <button id="cancelPass" class="small-btn">Cancel</button>
    </div>
  `;
  showModal(html);
  document.getElementById('cancelPass').addEventListener('click', hideModal);
  document.getElementById('savePass').addEventListener('click', async ()=>{
    const p = document.getElementById('newPass').value;
    const c = document.getElementById('confirmPass').value;
    if(!p || p.length < 4){ alert('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá 4 ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞ ‡¶π‡¶¨‡ßá'); return; }
    if(p !== c){ alert('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ'); return; }
    const h = await hashString(p);
    admin.passHash = h;
    save(KEY_ADMIN, admin);
    hideModal();
    showToast('Admin password ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá');
  });
}

/* ---------- Utility: SHA-256 hash for password ---------- */
async function hashString(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  const hex = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  return hex;
}

/* ---------- Toast ---------- */
function showToast(msg, t=2200){
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.position='fixed'; el.style.left='12px'; el.style.bottom='12px';
  el.style.background='rgba(0,0,0,0.6)'; el.style.color='#fff'; el.style.padding='10px 12px';
  el.style.borderRadius='8px'; el.style.fontSize='13px'; el.style.zIndex=9999;
  document.body.appendChild(el);
  setTimeout(()=>{ el.style.transition='opacity 300ms'; el.style.opacity='0'; }, t-300);
  setTimeout(()=> el.remove(), t);
}

/* ---------- Save/load helpers ---------- */
function save(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function load(key){ try{ const s = localStorage.getItem(key); return s ? JSON.parse(s) : null; }catch(e){ return null; } }

/* ---------- Initial render ---------- */
renderBooks();

/* ---------- Helpful note: open admin quickly with ?admin=1 ---------- */
if(location.search.indexOf('admin=1') !== -1){
  showLoginModal();
}
</script>
</body>
</html>
